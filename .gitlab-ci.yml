variables:
  IMAGE_NAME: junyhehe/ggorangjirang
  IMAGE_TAG: "1.0"

stages:
  - deploy

deploy:
  stage: deploy
  before_script:
    - chmod 400 $SSH_KEY
    - mkdir -p ~/.ssh
    - ssh-keyscan -H 34.64.229.17 >> ~/.ssh/known_hosts
  script:
    - ssh -i $SSH_KEY elice@34.64.229.17 "
      $DOCKER_REGISTRY_PASS | docker login --username $DOCKER_REGISTRY_USER --password-stdin &&
      docker ps -a &&
      docker stop app || true &&
      docker rm app || true &&
      docker rmi $IMAGE_NAME:$IMAGE_TAG &&
      docker pull $IMAGE_NAME:$IMAGE_TAG &&

      docker run -d -p 8080:8080 --name app $IMAGE_NAME:$IMAGE_TAG"
  tags:
    - deploy
